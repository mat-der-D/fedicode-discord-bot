# ローカルテストガイド

このガイドでは、Discord Bot の開発経験がない方でもローカル環境で Bot を動かしてテストできるよう、Discord Developer Portal での Bot 作成からローカル起動・動作確認までの一連の手順を説明します。

---

## 目次

1. [Discord アカウントの準備](#1-discord-アカウントの準備)
2. [テスト用サーバーの作成](#2-テスト用サーバーの作成)
3. [Discord Developer Portal で Application を作成](#3-discord-developer-portal-で-application-を作成)
4. [Bot ユーザーの作成とトークン取得](#4-bot-ユーザーの作成とトークン取得)
5. [特権 Intent の有効化](#5-特権-intent-の有効化)
6. [Bot をテスト用サーバーに招待](#6-bot-をテスト用サーバーに招待)
7. [ローカル環境のセットアップ](#7-ローカル環境のセットアップ)
8. [Bot の起動と動作確認](#8-bot-の起動と動作確認)
9. [トラブルシューティング](#9-トラブルシューティング)

---

## 1. Discord アカウントの準備

すでに Discord アカウントを持っている場合はこのステップをスキップしてください。

1. [Discord](https://discord.com/) にアクセスし、アカウントを作成します。
2. メールアドレスの認証を完了させます。

> **補足**: Developer Portal へのアクセスに追加の登録は不要です。通常の Discord アカウントがそのまま使えます。

---

## 2. テスト用サーバーの作成

Bot のテストには自分だけが使う Discord サーバーが必要です。本番の Fedicode サーバーではなく、個人のテスト用サーバーを使います。

1. Discord アプリ（デスクトップ版・ブラウザ版どちらでも可）を開きます。
2. 左側のサーバー一覧の一番下にある「**+**」ボタンをクリックします。
3. 「**オリジナルの作成**」を選択します。
4. 「**自分と友達のため**」を選択します。
5. サーバー名を入力します（例: `Bot テスト`）。
6. 「**新規作成**」をクリックします。

これでテスト用サーバーが作成されました。

---

## 3. Discord Developer Portal で Application を作成

1. [Discord Developer Portal](https://discord.com/developers/applications) にアクセスします。
2. Discord アカウントでログインします。
3. 右上の「**New Application**」ボタンをクリックします。
4. Application 名を入力します（例: `fedicode-bot-test`）。
   - この名前はテスト用なので自由に付けてください。
5. Developer Terms of Service と Developer Policy に同意し、「**Create**」をクリックします。

Application が作成されると、設定画面に遷移します。

---

## 4. Bot ユーザーの作成とトークン取得

### Bot ユーザーの確認

Application を作成すると、Bot ユーザーは自動的に作成されています。

1. 左メニューから「**Bot**」を選択します。

### トークンの取得

Bot Token は Bot をプログラムから操作するための認証キーです。

1. 「**Token**」セクションの「**Reset Token**」ボタンをクリックします。
2. 確認ダイアログが表示されたら「**Yes, do it!**」をクリックします。
   - 二段階認証を有効にしている場合は、認証コードの入力を求められます。
3. トークンが表示されるので、「**Copy**」ボタンをクリックしてコピーします。

> **重要**: トークンは一度しか表示されません。必ずこのタイミングでコピーしてください。もしコピーし損ねた場合は、再度「Reset Token」で新しいトークンを発行できます。

> **注意**: トークンは Bot を自由に操作できる秘密鍵です。**絶対に他人と共有したり、Git にコミットしたりしないでください。** もし漏洩した場合は、直ちに「Reset Token」で無効化してください。

---

## 5. 特権 Intent の有効化

この Bot は 2 つの特権 Intent（Privileged Gateway Intents）を使用しています。これらは Developer Portal で明示的に有効化する必要があります。

1. 左メニューの「**Bot**」ページ内、下方向にスクロールし「**Privileged Gateway Intents**」セクションを見つけます。
2. 以下の 2 つのトグルを **ON** にします。

| Intent | 説明 | 用途 |
|--------|------|------|
| **SERVER MEMBERS INTENT** | サーバーメンバーの情報を取得する権限 | メンバー関連の機能で使用 |
| **MESSAGE CONTENT INTENT** | メッセージの内容を読み取る権限 | メッセージの内容に基づく機能で使用 |

3. ページ下部の「**Save Changes**」をクリックして保存します。

> **補足**: これらの Intent を有効にしないと、Bot 起動時にエラーが発生します。

---

## 6. Bot をテスト用サーバーに招待

### 招待 URL の生成

1. 左メニューから「**OAuth2**」を選択します。
2. 「**OAuth2 URL Generator**」セクションまでスクロールします。
3. **SCOPES** から以下にチェックを入れます。
   - `bot`
   - `applications.commands`（スラッシュコマンドの登録に必要）
4. **BOT PERMISSIONS** が表示されるので、以下にチェックを入れます。
   - `Send Messages`（メッセージ送信）
   - `Use Slash Commands`（スラッシュコマンド使用）
   - 今後 Cog を追加する際に必要な権限があれば、その都度追加してください。
5. ページ下部に生成された **GENERATED URL** をコピーします。

### サーバーへの招待

1. コピーした URL をブラウザで開きます。
2. 「**サーバーに追加**」のドロップダウンから、先ほど作成したテスト用サーバーを選択します。
3. 「**はい**」をクリックします。
4. 権限の確認画面で「**認証**」をクリックします。

テスト用サーバーのメンバー一覧に Bot が表示されれば成功です（この時点ではオフライン状態）。

---

## 7. ローカル環境のセットアップ

### 前提条件

- **Python 3.12 以上** がインストールされていること
- **[uv](https://docs.astral.sh/uv/)** がインストールされていること

### 手順

```bash
# リポジトリをクローン（fork した場合は自分のリポジトリ URL を使う）
git clone <repository-url>
cd fedicode-discord-bot

# .env ファイルを作成
cp .env.example .env
```

`.env` ファイルをテキストエディタで開き、手順 4 で取得したトークンを設定します。

```
DISCORD_TOKEN=ここにコピーしたトークンを貼り付ける
```

> **注意**: トークンの前後に余計なスペースや引用符を入れないでください。

```bash
# 依存関係のインストール
uv sync
```

---

## 8. Bot の起動と動作確認

### Bot の起動

```bash
uv run python main.py
```

起動に成功すると、以下のようなログが出力されます。

```
INFO:__main__:Cog 読み込み成功: cogs.example
INFO:discord.client:logging in using static token
INFO:__main__:ログイン: BotName#1234 (ID: 123456789012345678)
INFO:__main__:スラッシュコマンド同期完了: 1 個
```

### 動作確認

1. テスト用サーバーの任意のテキストチャンネルを開きます。
2. メッセージ入力欄に `/ping` と入力します。
3. スラッシュコマンドの候補が表示されるので、Bot の `/ping` を選択して送信します。
4. Bot が「**Pong!!**」と返信すれば、正常に動作しています。

### Bot の停止

ターミナルで `Ctrl + C` を押すと Bot が停止します。

---

## 9. トラブルシューティング

### `DISCORD_TOKEN が設定されていません` と表示される

- `.env` ファイルが存在するか確認してください。
- `.env` ファイル内の `DISCORD_TOKEN=` の後にトークンが正しく設定されているか確認してください。

### `Privileged intent(s) are not enabled` エラー

- [手順 5](#5-特権-intent-の有効化) に戻り、Developer Portal で **SERVER MEMBERS INTENT** と **MESSAGE CONTENT INTENT** が ON になっているか確認してください。
- 変更後に「Save Changes」をクリックしたか確認してください。

### `/ping` コマンドが表示されない

- スラッシュコマンドの同期には数分かかる場合があります。しばらく待ってから再度試してください。
- ログに `スラッシュコマンド同期完了: 1 個` と表示されているか確認してください。0 個の場合、Cog の読み込みに失敗している可能性があります。
- Discord アプリを再起動すると表示されることがあります。

### `Cog 読み込み失敗` と表示される

- エラーメッセージの内容を確認し、該当する Cog ファイルの構文エラーを修正してください。
- `setup` 関数が正しく定義されているか確認してください（[仕様書](SPECIFICATION.md) の Cog 実装ルールを参照）。

### Bot がオフラインのまま

- ターミナルにエラーが出力されていないか確認してください。
- トークンが正しいか確認してください。Developer Portal で「Reset Token」を行い、新しいトークンを `.env` に設定し直してみてください。
- インターネット接続を確認してください。
